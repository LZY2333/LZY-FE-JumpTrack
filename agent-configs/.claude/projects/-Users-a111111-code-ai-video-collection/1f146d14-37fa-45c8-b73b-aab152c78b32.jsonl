{"type":"file-history-snapshot","messageId":"acb4bc48-5935-4f4b-85aa-8ef26590619e","snapshot":{"messageId":"acb4bc48-5935-4f4b-85aa-8ef26590619e","trackedFileBackups":{},"timestamp":"2026-02-27T02:28:51.328Z"},"isSnapshotUpdate":false}
{"parentUuid":null,"isSidechain":false,"userType":"external","cwd":"/Users/a111111/code/ai-video-collection","sessionId":"1f146d14-37fa-45c8-b73b-aab152c78b32","version":"2.1.62","gitBranch":"feat/template-category-show-code","type":"user","message":{"role":"user","content":"/Users/a111111/code/ai-video-collection/web/src/_blocks/Managements/Templates/index.tsx 当前表格太高,将底部顶出了视窗"},"uuid":"acb4bc48-5935-4f4b-85aa-8ef26590619e","timestamp":"2026-02-27T02:28:51.326Z"}
{"parentUuid":"acb4bc48-5935-4f4b-85aa-8ef26590619e","isSidechain":false,"userType":"external","cwd":"/Users/a111111/code/ai-video-collection","sessionId":"1f146d14-37fa-45c8-b73b-aab152c78b32","version":"2.1.62","gitBranch":"feat/template-category-show-code","message":{"content":[{"signature":"EuEBCkYICxgCKkD2hAK2oLFwDrBFXwnjZJ1inZUD01Nisl0yk50LnICK0UFBQSi4p6VHV3YAXtMM7BOWyQpJk+1XZGxYmbQmCXzZEgyCjgZC0x8Sqg+2UhEaDFb3NiC8RsgUnyh72iIwWvWKJixT+NzCOwF3C7CCDp6UBpBVrHOLQjy52rix3BlwFIrdzcobbd5gd30QBR6JKknLFzM+Yz4Icxjmka1Dn9ygNWbqy5bwi9E+R7e/GGdAAb9Am6CjjMcakNQ6896LZurFVxEsiq/x/ykjxgIBkTnOp5h6UFbotsdvGAE=","thinking":"Let me read the file to understand the current structure.","type":"thinking"}],"id":"msg_01W6mLjsW7vdwtvZPZ3U75mX","model":"claude-sonnet-4-6","role":"assistant","stop_reason":null,"stop_sequence":null,"type":"message","usage":{"cache_creation":{"ephemeral_1h_input_tokens":14781,"ephemeral_5m_input_tokens":0},"cache_creation_input_tokens":14781,"cache_read_input_tokens":10339,"inference_geo":"not_available","input_tokens":3,"output_tokens":1,"service_tier":"standard"}},"type":"assistant","uuid":"3cfe06c8-d51f-4356-bd84-b5c261c2dcfb","timestamp":"2026-02-27T02:28:56.007Z"}
{"parentUuid":"3cfe06c8-d51f-4356-bd84-b5c261c2dcfb","isSidechain":false,"userType":"external","cwd":"/Users/a111111/code/ai-video-collection","sessionId":"1f146d14-37fa-45c8-b73b-aab152c78b32","version":"2.1.62","gitBranch":"feat/template-category-show-code","slug":"twinkling-floating-trinket","message":{"content":[{"caller":{"type":"direct"},"id":"toolu_01E8pn8jttwoU8H5E9FmM1i1","input":{"file_path":"/Users/a111111/code/ai-video-collection/web/src/_blocks/Managements/Templates/index.tsx"},"name":"Read","type":"tool_use"}],"id":"msg_01W6mLjsW7vdwtvZPZ3U75mX","model":"claude-sonnet-4-6","role":"assistant","stop_reason":"tool_use","stop_sequence":null,"type":"message","usage":{"input_tokens":3,"cache_creation_input_tokens":14781,"cache_read_input_tokens":10339,"output_tokens":108,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":14781,"ephemeral_5m_input_tokens":0},"inference_geo":"","iterations":[],"speed":"standard"}},"type":"assistant","uuid":"3d2cb746-d209-4ce8-82d2-ee4aa96a25ca","timestamp":"2026-02-27T02:28:56.459Z"}
{"parentUuid":"3d2cb746-d209-4ce8-82d2-ee4aa96a25ca","isSidechain":false,"userType":"external","cwd":"/Users/a111111/code/ai-video-collection","sessionId":"1f146d14-37fa-45c8-b73b-aab152c78b32","version":"2.1.62","gitBranch":"feat/template-category-show-code","slug":"twinkling-floating-trinket","type":"progress","data":{"type":"hook_progress","hookEvent":"PostToolUse","hookName":"PostToolUse:Read","command":"callback"},"parentToolUseID":"toolu_01E8pn8jttwoU8H5E9FmM1i1","toolUseID":"toolu_01E8pn8jttwoU8H5E9FmM1i1","timestamp":"2026-02-27T02:28:56.485Z","uuid":"d9546429-c017-4fbe-a39c-174d505de30f"}
{"parentUuid":"3d2cb746-d209-4ce8-82d2-ee4aa96a25ca","isSidechain":false,"userType":"external","cwd":"/Users/a111111/code/ai-video-collection","sessionId":"1f146d14-37fa-45c8-b73b-aab152c78b32","version":"2.1.62","gitBranch":"feat/template-category-show-code","slug":"twinkling-floating-trinket","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01E8pn8jttwoU8H5E9FmM1i1","type":"tool_result","content":"     1→import TagCascader from '@/_blocks/Managements/_components/TagCascader'\n     2→import { api } from '@/utils/api'\n     3→import { ProTable } from '@ant-design/pro-components'\n     4→import {\n     5→  CreateVideoType,\n     6→  GenerationTemplateOpenType,\n     7→  GenerationTemplateStatus,\n     8→} from '@loc/prisma'\n     9→import { ETemplateSource } from '@loc/server/enums/template.common'\n    10→import { EServiceProvider } from '@loc/server/enums/video'\n    11→import { EVideoModel } from '@loc/server/enums/video.common'\n    12→import { TranslationTarget } from '@loc/server/interface/schema/translation.common'\n    13→import { Button, Image, Modal, Radio } from 'antd'\n    14→import { omit } from 'lodash-es'\n    15→\n    16→import type { ISelectedTag } from '@/_blocks/Managements/TagManagement/_components/TagSelectionModal/TagSelectionModalContent'\n    17→import type { RouterOutputs } from '@/utils/api'\n    18→import type { ActionType, ProColumns } from '@ant-design/pro-components'\n    19→\n    20→import { AddCategory } from '../_components/AddCategory'\n    21→import { ImportJsonModel } from '../_components/ImportJsonModel'\n    22→import { RefreshTrans } from '../_components/RefreshTrans'\n    23→import { handleExportJSON } from '../_helpers'\n    24→import { sleep } from '../_helpers/sleep'\n    25→import AddModal from './AddModal'\n    26→import { RelationDrawer } from './RelationDrawer'\n    27→\n    28→import type { IPermissionLayoutProps } from '../_layout'\n    29→import type { AccountInfo } from './AddModal/Creator'\n    30→\n    31→export type TTemplateList =\n    32→  RouterOutputs['generationTemplate']['pageTemplates']['items']\n    33→\n    34→export default function Usage(props: Pick<IPermissionLayoutProps, 'dark'>) {\n    35→  const actionRef = useRef<ActionType>()\n    36→\n    37→  const [serviceProvider, setServiceProvider] = useState<EServiceProvider>()\n    38→  const [source, setSource] = useState<ETemplateSource>()\n    39→  const [status, setStatus] = useState<GenerationTemplateStatus | undefined>()\n    40→  const [page, setPage] = useState(1)\n    41→  const [editItem, setEditItem] = useState<TTemplateList[0] | undefined>()\n    42→  const [open, setOpen] = useState(false)\n    43→  const [templateList, setTemplateList] = useState<TTemplateList | undefined>()\n    44→  const [relationOpen, setRelationOpen] = useState(false)\n    45→  const [openType, setOpenType] = useState<\n    46→    GenerationTemplateOpenType | undefined\n    47→  >()\n    48→\n    49→  const [importModelOpen, setImportJsonModelOpen] = useState(false)\n    50→  const [videoType, setVideoType] = useState<CreateVideoType>(\n    51→    CreateVideoType.Template,\n    52→  )\n    53→  const [title, setTitle] = useState('')\n    54→  const [selectedTags, setSelectedTags] = useState<ISelectedTag[]>([])\n    55→\n    56→  const { refetch } = api.generationTemplate.pageTemplates.useQuery(\n    57→    {\n    58→      status,\n    59→      page,\n    60→      serviceProvider,\n    61→      pageSize: 1000,\n    62→      videoType,\n    63→      openType,\n    64→      source,\n    65→      title,\n    66→      tagIds:\n    67→        selectedTags.length > 0 ? selectedTags.map((tag) => tag.id) : undefined,\n    68→    },\n    69→    {\n    70→      enabled: false,\n    71→    },\n    72→  )\n    73→\n    74→  useEffect(() => {\n    75→    if (actionRef.current) {\n    76→      actionRef.current.reload()\n    77→    }\n    78→  }, [status, serviceProvider, videoType, openType])\n    79→\n    80→  const { mutateAsync: updateStatus, isLoading: isUpdatingStatus } =\n    81→    api.generationTemplate.updateStatus.useMutation()\n    82→\n    83→  const onChangeStatus = async (\n    84→    status: GenerationTemplateStatus,\n    85→    id: string,\n    86→  ) => {\n    87→    await Modal.confirm({\n    88→      title: 'Are you sure you want to update the status?',\n    89→      onOk: async () => {\n    90→        await updateStatus({\n    91→          id,\n    92→          status,\n    93→        })\n    94→        actionRef.current?.reload()\n    95→      },\n    96→    })\n    97→  }\n    98→\n    99→  const columns: ProColumns<TTemplateList[0]>[] = [\n   100→    {\n   101→      title: 'Sort',\n   102→      dataIndex: 'sort',\n   103→      hideInSearch: true,\n   104→      renderText(text) {\n   105→        return text ?? '--'\n   106→      },\n   107→    },\n   108→    {\n   109→      title: 'Title',\n   110→      dataIndex: 'title',\n   111→      minWidth: 200,\n   112→      search: {\n   113→        transform: (value) => setTitle(value),\n   114→      },\n   115→    },\n   116→    {\n   117→      title: 'Tag(new)',\n   118→      dataIndex: 'tagIds',\n   119→      hideInTable: true,\n   120→      renderFormItem: () => (\n   121→        <TagCascader value={selectedTags} onChange={setSelectedTags} />\n   122→      ),\n   123→    },\n   124→    {\n   125→      title: 'Video type',\n   126→      dataIndex: 'videoType',\n   127→      valueEnum: CreateVideoType,\n   128→      valueType: 'select',\n   129→      search: {\n   130→        transform: (value) => setVideoType(value as CreateVideoType),\n   131→      },\n   132→    },\n   133→    {\n   134→      title: 'Open Type',\n   135→      dataIndex: 'openType',\n   136→      valueEnum: GenerationTemplateOpenType,\n   137→      hideInTable: true,\n   138→      valueType: 'select',\n   139→      search: {\n   140→        transform: (value) => setOpenType(value as GenerationTemplateOpenType),\n   141→      },\n   142→    },\n   143→    {\n   144→      title: 'Service provider',\n   145→      dataIndex: 'serviceProvider',\n   146→      valueEnum: EServiceProvider,\n   147→      valueType: 'select',\n   148→      search: {\n   149→        transform: (value) =>\n   150→          setServiceProvider(\n   151→            EServiceProvider[value as keyof typeof EServiceProvider],\n   152→          ),\n   153→      },\n   154→    },\n   155→    {\n   156→      title: 'Model',\n   157→      dataIndex: 'videoModel',\n   158→      valueEnum: EVideoModel,\n   159→      valueType: 'select',\n   160→      hideInSearch: true,\n   161→    },\n   162→    {\n   163→      title: 'Template code',\n   164→      dataIndex: 'templateCode',\n   165→      hideInSearch: true,\n   166→      minWidth: 200,\n   167→    },\n   168→    // {\n   169→    //   title: 'Assets count',\n   170→    //   dataIndex: 'assetsNum',\n   171→    //   hideInSearch: true,\n   172→    // },\n   173→    // {\n   174→    //   title: 'Assets type',\n   175→    //   dataIndex: 'assetsType',\n   176→    //   hideInSearch: true,\n   177→    // },\n   178→    {\n   179→      title: 'Image ratio',\n   180→      dataIndex: 'aspectRatio',\n   181→      hideInSearch: true,\n   182→    },\n   183→    // s\n   184→    // {\n   185→    //   title: 'Credits',\n   186→    //   dataIndex: 'templateCredit',\n   187→    //   hideInSearch: true,\n   188→    // },\n   189→    // {\n   190→    //   title: 'Corner mark',\n   191→    //   dataIndex: 'templateMarks',\n   192→    //   hideInSearch: true,\n   193→    //   renderText(arr) {\n   194→    //     return (arr || []).join('、')\n   195→    //   },\n   196→    // },\n   197→    {\n   198→      title: 'Status',\n   199→      dataIndex: 'status',\n   200→      valueEnum: GenerationTemplateStatus,\n   201→      renderText(text, record) {\n   202→        const isENABLED = text === GenerationTemplateStatus.ENABLED\n   203→        const isDISABLED = text === GenerationTemplateStatus.DISABLED\n   204→        const isHIDDEN = text === GenerationTemplateStatus.HIDDEN\n   205→        return (\n   206→          <Radio.Group\n   207→            disabled={isUpdatingStatus}\n   208→            value={text}\n   209→            onChange={(e) => {\n   210→              onChangeStatus(e.target.value, record.id)\n   211→            }}\n   212→          >\n   213→            <Radio value={GenerationTemplateStatus.ENABLED}>\n   214→              <span className={cls`text-xs ${isENABLED && 'text-f-success'}`}>\n   215→                Enabled\n   216→              </span>\n   217→            </Radio>\n   218→            <Radio value={GenerationTemplateStatus.DISABLED}>\n   219→              <span className={cls`text-xs ${isDISABLED && 'text-f-error'}`}>\n   220→                Disabled\n   221→              </span>\n   222→            </Radio>\n   223→            <Radio value={GenerationTemplateStatus.HIDDEN}>\n   224→              <span className={cls`text-xs ${isHIDDEN && 'text-f-error'}`}>\n   225→                Hidden\n   226→              </span>\n   227→            </Radio>\n   228→            {/* <Radio value={GenerationTemplateStatus.DELETED}>\n   229→              <span className='text-xs'>Deleted</span>\n   230→            </Radio> */}\n   231→          </Radio.Group>\n   232→        )\n   233→      },\n   234→      search: {\n   235→        transform: (value) => setStatus(value),\n   236→      },\n   237→    },\n   238→    {\n   239→      title: 'Cover image',\n   240→      dataIndex: 'coverImg',\n   241→      hideInSearch: true,\n   242→      render(text, record) {\n   243→        return record.coverImg ? (\n   244→          <Image\n   245→            src={record.coverImg}\n   246→            className='!h-[100px] !w-[200px] object-contain'\n   247→          />\n   248→        ) : (\n   249→          ''\n   250→        )\n   251→      },\n   252→    },\n   253→    {\n   254→      title: 'Source',\n   255→      dataIndex: 'source',\n   256→      valueType: 'select',\n   257→      valueEnum: ETemplateSource,\n   258→      initialValue: ETemplateSource.Official,\n   259→      render(text, record) {\n   260→        return record.source\n   261→      },\n   262→      search: {\n   263→        transform: (value) =>\n   264→          setSource(ETemplateSource[value as keyof typeof ETemplateSource]),\n   265→      },\n   266→    },\n   267→    {\n   268→      title: '已关联的分类',\n   269→      dataIndex: 'categoryGenerationTemplateIdList',\n   270→      key: 'categoryGenerationTemplateIdList',\n   271→      hideInSearch: true,\n   272→      width: 150,\n   273→      render: (_, record) => {\n   274→        return (\n   275→          <AddCategory\n   276→            mode='table'\n   277→            value={record.categoryGenerationTemplateIdList}\n   278→            templateId={record.id || ''}\n   279→          />\n   280→        )\n   281→      },\n   282→    },\n   283→    // {\n   284→    //   title: 'Video',\n   285→    //   dataIndex: 'coverVideo',\n   286→    //   hideInSearch: true,\n   287→    //   renderText(text, record) {\n   288→    //     return (\n   289→    //       <div className='h-[100px] w-[200px]'>\n   290→    //         {record.coverVideo ? (\n   291→    //           <video\n   292→    //             src={record.coverVideo}\n   293→    //             controls\n   294→    //             className='h-[100px] w-[200px]'\n   295→    //           />\n   296→    //         ) : (\n   297→    //           ''\n   298→    //         )}\n   299→    //       </div>\n   300→    //     )\n   301→    //   },\n   302→    // },\n   303→    // {\n   304→    //   title: 'Category',\n   305→    //   dataIndex: 'templateCategory',\n   306→    //   hideInSearch: true,\n   307→    // },\n   308→    // {\n   309→    //   title: 'Enable hover',\n   310→    //   dataIndex: 'enableHover',\n   311→    //   hideInSearch: true,\n   312→    // },\n   313→    // {\n   314→    //   title: 'Max length',\n   315→    //   dataIndex: 'maxLength',\n   316→    //   hideInSearch: true,\n   317→    // },\n   318→    // {\n   319→    //   title: 'Comments',\n   320→    //   dataIndex: 'comments',\n   321→    //   hideInSearch: true,\n   322→    // },\n   323→    {\n   324→      title: 'Option',\n   325→      valueType: 'option',\n   326→      width: 150,\n   327→      fixed: 'right',\n   328→      render: (text, record, _, action) => [\n   329→        <div key='editable' className='flex flex-col gap-1'>\n   330→          <Button\n   331→            type='primary'\n   332→            onClick={() => {\n   333→              setOpen(true)\n   334→              setEditItem(record)\n   335→            }}\n   336→          >\n   337→            Edit\n   338→          </Button>\n   339→          <Button\n   340→            type='primary'\n   341→            onClick={() => {\n   342→              setRelationOpen(true)\n   343→              setEditItem(record)\n   344→            }}\n   345→          >\n   346→            Sub Templates\n   347→          </Button>\n   348→          <Button type='primary'>\n   349→            <Link\n   350→              href={`/video-effects/${record.templateCode}`}\n   351→              target='_blank'\n   352→              className='hover:!text-f-text'\n   353→            >\n   354→              Try Template\n   355→            </Link>\n   356→          </Button>\n   357→          <Button\n   358→            type='primary'\n   359→            onClick={() => {\n   360→              handleExportJSON(\n   361→                omit(record, [\n   362→                  'id',\n   363→                  'createdDate',\n   364→                  'updatedDate',\n   365→                  'subTemplates',\n   366→                  'user',\n   367→                  'userId',\n   368→                ]),\n   369→              )\n   370→            }}\n   371→          >\n   372→            Export Data\n   373→          </Button>\n   374→        </div>,\n   375→      ],\n   376→    },\n   377→  ]\n   378→\n   379→  const onEditItemChange = (value: AccountInfo) => {\n   380→    if (!editItem || !value) return\n   381→    const newUser = {} as NonNullable<TTemplateList[0]['user']>\n   382→    for (const k in editItem.user) {\n   383→      const key = k as keyof TTemplateList[0]['user'] &\n   384→        keyof AccountInfo['userInfo']\n   385→      newUser[key] = value.userInfo[key] as (typeof newUser)[typeof key]\n   386→    }\n   387→    setEditItem({\n   388→      ...editItem,\n   389→      userId: value.userInfo.id,\n   390→      user: newUser,\n   391→    })\n   392→  }\n   393→\n   394→  return (\n   395→    <>\n   396→      <ProTable<TTemplateList[0]>\n   397→        columns={columns}\n   398→        actionRef={actionRef}\n   399→        cardBordered\n   400→        request={async (params) => {\n   401→          const { data } = await refetch()\n   402→          const list = data || { items: [], total: 0 }\n   403→          setTemplateList(list.items)\n   404→          return Promise.resolve({\n   405→            data: list.items,\n   406→            total: list.total,\n   407→            success: true,\n   408→          })\n   409→        }}\n   410→        scroll={{\n   411→          x: 1200,\n   412→        }}\n   413→        rowKey='id'\n   414→        search={{\n   415→          labelWidth: 'auto',\n   416→          optionRender: ({ searchText, resetText }, { form }) => [\n   417→            <div className='flex gap-x-2' key={'search'}>\n   418→              <Button\n   419→                type='primary'\n   420→                onClick={() => {\n   421→                  setTitle('')\n   422→                  setServiceProvider(undefined)\n   423→                  setVideoType(CreateVideoType.Template)\n   424→                  setOpenType(undefined)\n   425→                  setStatus(undefined)\n   426→                  setSelectedTags([])\n   427→\n   428→                  form?.resetFields()\n   429→                }}\n   430→              >\n   431→                {resetText}\n   432→              </Button>\n   433→              <Button\n   434→                type='primary'\n   435→                onClick={async () => {\n   436→                  form?.submit()\n   437→                }}\n   438→              >\n   439→                {searchText}\n   440→              </Button>\n   441→            </div>,\n   442→          ],\n   443→        }}\n   444→        options={{\n   445→          setting: {\n   446→            listsHeight: 400,\n   447→          },\n   448→        }}\n   449→        pagination={{\n   450→          current: page,\n   451→          pageSize: 1000,\n   452→          onChange: (page) => {\n   453→            setPage(page)\n   454→            sleep(100)\n   455→            actionRef.current?.reload()\n   456→          },\n   457→        }}\n   458→        headerTitle='Config'\n   459→        toolBarRender={() => [\n   460→          <Button\n   461→            className={cls`flex items-center gap-x-1`}\n   462→            key='button'\n   463→            onClick={() => {\n   464→              setOpen(true)\n   465→              setEditItem(undefined)\n   466→            }}\n   467→            type='primary'\n   468→          >\n   469→            <span>Add</span>\n   470→          </Button>,\n   471→          <RefreshTrans\n   472→            key='refresh'\n   473→            target={TranslationTarget.GENERATION_TEMPLATE}\n   474→          />,\n   475→          <Button\n   476→            className={cls`flex items-center gap-x-1`}\n   477→            key='import'\n   478→            type='primary'\n   479→            onClick={() => {\n   480→              setImportJsonModelOpen(true)\n   481→            }}\n   482→          >\n   483→            <span>Import JSON</span>\n   484→          </Button>,\n   485→        ]}\n   486→      />\n   487→      <AddModal\n   488→        editItem={editItem}\n   489→        open={open}\n   490→        onCancel={(reload) => {\n   491→          setOpen(false)\n   492→          setEditItem(undefined)\n   493→          if (reload) {\n   494→            actionRef.current?.reload(true)\n   495→          }\n   496→        }}\n   497→        onEditItemChange={onEditItemChange}\n   498→      />\n   499→      <RelationDrawer\n   500→        onCancel={() => {\n   501→          setRelationOpen(false)\n   502→          setEditItem(undefined)\n   503→        }}\n   504→        allTemplates={templateList}\n   505→        editItem={editItem}\n   506→        open={relationOpen}\n   507→        refetch={async () => {\n   508→          const { data } = await refetch()\n   509→          if (data) {\n   510→            setEditItem(data.items[0])\n   511→          }\n   512→          actionRef.current?.reload(true)\n   513→        }}\n   514→      />\n   515→      <ImportJsonModel\n   516→        open={importModelOpen}\n   517→        onCancel={() => {\n   518→          setImportJsonModelOpen(false)\n   519→          setEditItem(undefined)\n   520→        }}\n   521→        onOk={() => {\n   522→          setImportJsonModelOpen(false)\n   523→          setOpen(true)\n   524→        }}\n   525→        onChange={(value) => {\n   526→          setEditItem(value)\n   527→        }}\n   528→      />\n   529→    </>\n   530→  )\n   531→}\n   532→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"d2ee4001-2d68-4b91-bef9-87dd0477b2c8","timestamp":"2026-02-27T02:28:56.484Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/a111111/code/ai-video-collection/web/src/_blocks/Managements/Templates/index.tsx","content":"import TagCascader from '@/_blocks/Managements/_components/TagCascader'\nimport { api } from '@/utils/api'\nimport { ProTable } from '@ant-design/pro-components'\nimport {\n  CreateVideoType,\n  GenerationTemplateOpenType,\n  GenerationTemplateStatus,\n} from '@loc/prisma'\nimport { ETemplateSource } from '@loc/server/enums/template.common'\nimport { EServiceProvider } from '@loc/server/enums/video'\nimport { EVideoModel } from '@loc/server/enums/video.common'\nimport { TranslationTarget } from '@loc/server/interface/schema/translation.common'\nimport { Button, Image, Modal, Radio } from 'antd'\nimport { omit } from 'lodash-es'\n\nimport type { ISelectedTag } from '@/_blocks/Managements/TagManagement/_components/TagSelectionModal/TagSelectionModalContent'\nimport type { RouterOutputs } from '@/utils/api'\nimport type { ActionType, ProColumns } from '@ant-design/pro-components'\n\nimport { AddCategory } from '../_components/AddCategory'\nimport { ImportJsonModel } from '../_components/ImportJsonModel'\nimport { RefreshTrans } from '../_components/RefreshTrans'\nimport { handleExportJSON } from '../_helpers'\nimport { sleep } from '../_helpers/sleep'\nimport AddModal from './AddModal'\nimport { RelationDrawer } from './RelationDrawer'\n\nimport type { IPermissionLayoutProps } from '../_layout'\nimport type { AccountInfo } from './AddModal/Creator'\n\nexport type TTemplateList =\n  RouterOutputs['generationTemplate']['pageTemplates']['items']\n\nexport default function Usage(props: Pick<IPermissionLayoutProps, 'dark'>) {\n  const actionRef = useRef<ActionType>()\n\n  const [serviceProvider, setServiceProvider] = useState<EServiceProvider>()\n  const [source, setSource] = useState<ETemplateSource>()\n  const [status, setStatus] = useState<GenerationTemplateStatus | undefined>()\n  const [page, setPage] = useState(1)\n  const [editItem, setEditItem] = useState<TTemplateList[0] | undefined>()\n  const [open, setOpen] = useState(false)\n  const [templateList, setTemplateList] = useState<TTemplateList | undefined>()\n  const [relationOpen, setRelationOpen] = useState(false)\n  const [openType, setOpenType] = useState<\n    GenerationTemplateOpenType | undefined\n  >()\n\n  const [importModelOpen, setImportJsonModelOpen] = useState(false)\n  const [videoType, setVideoType] = useState<CreateVideoType>(\n    CreateVideoType.Template,\n  )\n  const [title, setTitle] = useState('')\n  const [selectedTags, setSelectedTags] = useState<ISelectedTag[]>([])\n\n  const { refetch } = api.generationTemplate.pageTemplates.useQuery(\n    {\n      status,\n      page,\n      serviceProvider,\n      pageSize: 1000,\n      videoType,\n      openType,\n      source,\n      title,\n      tagIds:\n        selectedTags.length > 0 ? selectedTags.map((tag) => tag.id) : undefined,\n    },\n    {\n      enabled: false,\n    },\n  )\n\n  useEffect(() => {\n    if (actionRef.current) {\n      actionRef.current.reload()\n    }\n  }, [status, serviceProvider, videoType, openType])\n\n  const { mutateAsync: updateStatus, isLoading: isUpdatingStatus } =\n    api.generationTemplate.updateStatus.useMutation()\n\n  const onChangeStatus = async (\n    status: GenerationTemplateStatus,\n    id: string,\n  ) => {\n    await Modal.confirm({\n      title: 'Are you sure you want to update the status?',\n      onOk: async () => {\n        await updateStatus({\n          id,\n          status,\n        })\n        actionRef.current?.reload()\n      },\n    })\n  }\n\n  const columns: ProColumns<TTemplateList[0]>[] = [\n    {\n      title: 'Sort',\n      dataIndex: 'sort',\n      hideInSearch: true,\n      renderText(text) {\n        return text ?? '--'\n      },\n    },\n    {\n      title: 'Title',\n      dataIndex: 'title',\n      minWidth: 200,\n      search: {\n        transform: (value) => setTitle(value),\n      },\n    },\n    {\n      title: 'Tag(new)',\n      dataIndex: 'tagIds',\n      hideInTable: true,\n      renderFormItem: () => (\n        <TagCascader value={selectedTags} onChange={setSelectedTags} />\n      ),\n    },\n    {\n      title: 'Video type',\n      dataIndex: 'videoType',\n      valueEnum: CreateVideoType,\n      valueType: 'select',\n      search: {\n        transform: (value) => setVideoType(value as CreateVideoType),\n      },\n    },\n    {\n      title: 'Open Type',\n      dataIndex: 'openType',\n      valueEnum: GenerationTemplateOpenType,\n      hideInTable: true,\n      valueType: 'select',\n      search: {\n        transform: (value) => setOpenType(value as GenerationTemplateOpenType),\n      },\n    },\n    {\n      title: 'Service provider',\n      dataIndex: 'serviceProvider',\n      valueEnum: EServiceProvider,\n      valueType: 'select',\n      search: {\n        transform: (value) =>\n          setServiceProvider(\n            EServiceProvider[value as keyof typeof EServiceProvider],\n          ),\n      },\n    },\n    {\n      title: 'Model',\n      dataIndex: 'videoModel',\n      valueEnum: EVideoModel,\n      valueType: 'select',\n      hideInSearch: true,\n    },\n    {\n      title: 'Template code',\n      dataIndex: 'templateCode',\n      hideInSearch: true,\n      minWidth: 200,\n    },\n    // {\n    //   title: 'Assets count',\n    //   dataIndex: 'assetsNum',\n    //   hideInSearch: true,\n    // },\n    // {\n    //   title: 'Assets type',\n    //   dataIndex: 'assetsType',\n    //   hideInSearch: true,\n    // },\n    {\n      title: 'Image ratio',\n      dataIndex: 'aspectRatio',\n      hideInSearch: true,\n    },\n    // s\n    // {\n    //   title: 'Credits',\n    //   dataIndex: 'templateCredit',\n    //   hideInSearch: true,\n    // },\n    // {\n    //   title: 'Corner mark',\n    //   dataIndex: 'templateMarks',\n    //   hideInSearch: true,\n    //   renderText(arr) {\n    //     return (arr || []).join('、')\n    //   },\n    // },\n    {\n      title: 'Status',\n      dataIndex: 'status',\n      valueEnum: GenerationTemplateStatus,\n      renderText(text, record) {\n        const isENABLED = text === GenerationTemplateStatus.ENABLED\n        const isDISABLED = text === GenerationTemplateStatus.DISABLED\n        const isHIDDEN = text === GenerationTemplateStatus.HIDDEN\n        return (\n          <Radio.Group\n            disabled={isUpdatingStatus}\n            value={text}\n            onChange={(e) => {\n              onChangeStatus(e.target.value, record.id)\n            }}\n          >\n            <Radio value={GenerationTemplateStatus.ENABLED}>\n              <span className={cls`text-xs ${isENABLED && 'text-f-success'}`}>\n                Enabled\n              </span>\n            </Radio>\n            <Radio value={GenerationTemplateStatus.DISABLED}>\n              <span className={cls`text-xs ${isDISABLED && 'text-f-error'}`}>\n                Disabled\n              </span>\n            </Radio>\n            <Radio value={GenerationTemplateStatus.HIDDEN}>\n              <span className={cls`text-xs ${isHIDDEN && 'text-f-error'}`}>\n                Hidden\n              </span>\n            </Radio>\n            {/* <Radio value={GenerationTemplateStatus.DELETED}>\n              <span className='text-xs'>Deleted</span>\n            </Radio> */}\n          </Radio.Group>\n        )\n      },\n      search: {\n        transform: (value) => setStatus(value),\n      },\n    },\n    {\n      title: 'Cover image',\n      dataIndex: 'coverImg',\n      hideInSearch: true,\n      render(text, record) {\n        return record.coverImg ? (\n          <Image\n            src={record.coverImg}\n            className='!h-[100px] !w-[200px] object-contain'\n          />\n        ) : (\n          ''\n        )\n      },\n    },\n    {\n      title: 'Source',\n      dataIndex: 'source',\n      valueType: 'select',\n      valueEnum: ETemplateSource,\n      initialValue: ETemplateSource.Official,\n      render(text, record) {\n        return record.source\n      },\n      search: {\n        transform: (value) =>\n          setSource(ETemplateSource[value as keyof typeof ETemplateSource]),\n      },\n    },\n    {\n      title: '已关联的分类',\n      dataIndex: 'categoryGenerationTemplateIdList',\n      key: 'categoryGenerationTemplateIdList',\n      hideInSearch: true,\n      width: 150,\n      render: (_, record) => {\n        return (\n          <AddCategory\n            mode='table'\n            value={record.categoryGenerationTemplateIdList}\n            templateId={record.id || ''}\n          />\n        )\n      },\n    },\n    // {\n    //   title: 'Video',\n    //   dataIndex: 'coverVideo',\n    //   hideInSearch: true,\n    //   renderText(text, record) {\n    //     return (\n    //       <div className='h-[100px] w-[200px]'>\n    //         {record.coverVideo ? (\n    //           <video\n    //             src={record.coverVideo}\n    //             controls\n    //             className='h-[100px] w-[200px]'\n    //           />\n    //         ) : (\n    //           ''\n    //         )}\n    //       </div>\n    //     )\n    //   },\n    // },\n    // {\n    //   title: 'Category',\n    //   dataIndex: 'templateCategory',\n    //   hideInSearch: true,\n    // },\n    // {\n    //   title: 'Enable hover',\n    //   dataIndex: 'enableHover',\n    //   hideInSearch: true,\n    // },\n    // {\n    //   title: 'Max length',\n    //   dataIndex: 'maxLength',\n    //   hideInSearch: true,\n    // },\n    // {\n    //   title: 'Comments',\n    //   dataIndex: 'comments',\n    //   hideInSearch: true,\n    // },\n    {\n      title: 'Option',\n      valueType: 'option',\n      width: 150,\n      fixed: 'right',\n      render: (text, record, _, action) => [\n        <div key='editable' className='flex flex-col gap-1'>\n          <Button\n            type='primary'\n            onClick={() => {\n              setOpen(true)\n              setEditItem(record)\n            }}\n          >\n            Edit\n          </Button>\n          <Button\n            type='primary'\n            onClick={() => {\n              setRelationOpen(true)\n              setEditItem(record)\n            }}\n          >\n            Sub Templates\n          </Button>\n          <Button type='primary'>\n            <Link\n              href={`/video-effects/${record.templateCode}`}\n              target='_blank'\n              className='hover:!text-f-text'\n            >\n              Try Template\n            </Link>\n          </Button>\n          <Button\n            type='primary'\n            onClick={() => {\n              handleExportJSON(\n                omit(record, [\n                  'id',\n                  'createdDate',\n                  'updatedDate',\n                  'subTemplates',\n                  'user',\n                  'userId',\n                ]),\n              )\n            }}\n          >\n            Export Data\n          </Button>\n        </div>,\n      ],\n    },\n  ]\n\n  const onEditItemChange = (value: AccountInfo) => {\n    if (!editItem || !value) return\n    const newUser = {} as NonNullable<TTemplateList[0]['user']>\n    for (const k in editItem.user) {\n      const key = k as keyof TTemplateList[0]['user'] &\n        keyof AccountInfo['userInfo']\n      newUser[key] = value.userInfo[key] as (typeof newUser)[typeof key]\n    }\n    setEditItem({\n      ...editItem,\n      userId: value.userInfo.id,\n      user: newUser,\n    })\n  }\n\n  return (\n    <>\n      <ProTable<TTemplateList[0]>\n        columns={columns}\n        actionRef={actionRef}\n        cardBordered\n        request={async (params) => {\n          const { data } = await refetch()\n          const list = data || { items: [], total: 0 }\n          setTemplateList(list.items)\n          return Promise.resolve({\n            data: list.items,\n            total: list.total,\n            success: true,\n          })\n        }}\n        scroll={{\n          x: 1200,\n        }}\n        rowKey='id'\n        search={{\n          labelWidth: 'auto',\n          optionRender: ({ searchText, resetText }, { form }) => [\n            <div className='flex gap-x-2' key={'search'}>\n              <Button\n                type='primary'\n                onClick={() => {\n                  setTitle('')\n                  setServiceProvider(undefined)\n                  setVideoType(CreateVideoType.Template)\n                  setOpenType(undefined)\n                  setStatus(undefined)\n                  setSelectedTags([])\n\n                  form?.resetFields()\n                }}\n              >\n                {resetText}\n              </Button>\n              <Button\n                type='primary'\n                onClick={async () => {\n                  form?.submit()\n                }}\n              >\n                {searchText}\n              </Button>\n            </div>,\n          ],\n        }}\n        options={{\n          setting: {\n            listsHeight: 400,\n          },\n        }}\n        pagination={{\n          current: page,\n          pageSize: 1000,\n          onChange: (page) => {\n            setPage(page)\n            sleep(100)\n            actionRef.current?.reload()\n          },\n        }}\n        headerTitle='Config'\n        toolBarRender={() => [\n          <Button\n            className={cls`flex items-center gap-x-1`}\n            key='button'\n            onClick={() => {\n              setOpen(true)\n              setEditItem(undefined)\n            }}\n            type='primary'\n          >\n            <span>Add</span>\n          </Button>,\n          <RefreshTrans\n            key='refresh'\n            target={TranslationTarget.GENERATION_TEMPLATE}\n          />,\n          <Button\n            className={cls`flex items-center gap-x-1`}\n            key='import'\n            type='primary'\n            onClick={() => {\n              setImportJsonModelOpen(true)\n            }}\n          >\n            <span>Import JSON</span>\n          </Button>,\n        ]}\n      />\n      <AddModal\n        editItem={editItem}\n        open={open}\n        onCancel={(reload) => {\n          setOpen(false)\n          setEditItem(undefined)\n          if (reload) {\n            actionRef.current?.reload(true)\n          }\n        }}\n        onEditItemChange={onEditItemChange}\n      />\n      <RelationDrawer\n        onCancel={() => {\n          setRelationOpen(false)\n          setEditItem(undefined)\n        }}\n        allTemplates={templateList}\n        editItem={editItem}\n        open={relationOpen}\n        refetch={async () => {\n          const { data } = await refetch()\n          if (data) {\n            setEditItem(data.items[0])\n          }\n          actionRef.current?.reload(true)\n        }}\n      />\n      <ImportJsonModel\n        open={importModelOpen}\n        onCancel={() => {\n          setImportJsonModelOpen(false)\n          setEditItem(undefined)\n        }}\n        onOk={() => {\n          setImportJsonModelOpen(false)\n          setOpen(true)\n        }}\n        onChange={(value) => {\n          setEditItem(value)\n        }}\n      />\n    </>\n  )\n}\n","numLines":532,"startLine":1,"totalLines":532}},"sourceToolAssistantUUID":"3d2cb746-d209-4ce8-82d2-ee4aa96a25ca"}
{"parentUuid":"d2ee4001-2d68-4b91-bef9-87dd0477b2c8","isSidechain":false,"userType":"external","cwd":"/Users/a111111/code/ai-video-collection","sessionId":"1f146d14-37fa-45c8-b73b-aab152c78b32","version":"2.1.62","gitBranch":"feat/template-category-show-code","slug":"twinkling-floating-trinket","type":"assistant","uuid":"cedcb3fb-69eb-45a9-a4f4-44b9795f7b5e","timestamp":"2026-02-27T02:28:57.534Z","message":{"id":"349ed8a6-8680-4e69-b578-8a64aaaafd3c","container":null,"model":"<synthetic>","role":"assistant","stop_reason":"stop_sequence","stop_sequence":"","type":"message","usage":{"input_tokens":0,"output_tokens":0,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":null,"cache_creation":{"ephemeral_1h_input_tokens":0,"ephemeral_5m_input_tokens":0},"inference_geo":null,"iterations":null,"speed":null},"content":[{"type":"text","text":"API Error: 403 {\"error\":{\"type\":\"new_api_error\",\"message\":\"预扣费额度失败, 用户剩余额度: ＄0.393042, 需要预扣费额度: ＄0.396000 (request id: 20260227022856918601474hsFHftwp)\"},\"type\":\"error\"} · Please run /login"}],"context_management":null},"error":"authentication_failed","isApiErrorMessage":true}
