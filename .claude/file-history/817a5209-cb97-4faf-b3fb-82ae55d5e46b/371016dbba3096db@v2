import { useContentTrack } from '@/_blocks/Analytics/hooks/useContentTrack'
import {
  getIsRecordFromImageTool,
  getIsRecordFromVideoTools,
} from '@/pages/pollo.ai/_components/CreationRecords/helper'
import { useVideoPublishStatus } from '@/pages/pollo.ai/_components/MenuOptions/_hooks/menuStates/publish/videoPublishStatus'
import { useExtendHidden } from '@/pages/pollo.ai/_hooks/useExtendDIsable'
import { VideoLike } from '@/pages/pollo.ai/assets/_blocks/VideoWindow/VideoLike'
import { useIsLipSyncVideoType } from '@/pages/pollo.ai/tool/_blocks/tools/VideoLipSync/_hooks/useIsLipSyncVideoType'
import { useIsMySelf } from '@/pages/pollo.ai/v/[id]/_hooks/isMySelf'
import { useLingui } from '@lingui/react/macro'
import { EProcessVideoType } from '@loc/server/enums/video'

import type {
  MenuCoreOption,
  MenuCustomOption,
  TImageMenuOptionKey,
  TVideoMenuOptionKey,
} from '@/pages/pollo.ai/_components/MenuOptions/_types'
import type {
  CreationItem,
  GenerationItem,
} from '@/pages/pollo.ai/_types/video'

import CreateSimilarVideo from './CreateSimilarVideo'
import FooterMenuOptions from './FooterMenuOptions'

import type { TOnUpdateVideo } from '../../../_hooks/useVideoDetail'

interface IFooterProps {
  data: CreationItem & {
    reallyVideoId?: string
    reallyVideoUrl?: string
  }
  generation?: GenerationItem
  onUpdateVideo?: TOnUpdateVideo
  isImage?: boolean
  onDeleteImageSuccess?: (generationId: string) => void
  updateFavorite?: (videoId: string, favorite: boolean) => void
  openInNewWindow?: boolean
}

const Footer = (props: IFooterProps) => {
  const {
    data,
    onUpdateVideo,
    isImage,
    onDeleteImageSuccess,
    updateFavorite,
    generation,
    openInNewWindow,
  } = props

  const { t } = useLingui()

  const { isMySelf } = useIsMySelf(data)
  const isRecordGenerateByVideoSound =
    data.generateRecord.processType === EProcessVideoType.VIDEO2AUDIOVIDEO
  const { handleClick } = useContentTrack()

  const { isSimilarDisable } = useExtendHidden({ video: data })

  // FIXME: 兼容一下
  const { isPublished } = useVideoPublishStatus({
    videoItem: generation ? { ...data, ...generation } : data,
  })

  const isAgentDetail = data.generateRecord.entryCode === 'Agent'

  const generateRecordType = data?.generateRecord?.type
  const isLipSync = useIsLipSyncVideoType({ videoType: generateRecordType })
  const isFromVideoTools = getIsRecordFromVideoTools(data)

  const visibleVideoOptions = useMemo(() => {
    const list: MenuCustomOption<TVideoMenuOptionKey>[] = Array.from<
      MenuCustomOption<TVideoMenuOptionKey> & {
        show: boolean
        children?: MenuCoreOption[]
      }
    >([
      {
        key: 'copyLink',
        sourceType: 'detailModal',
        show: true,
        showTooltip: true,
        onTrack: (element) => {
          handleClick(data, element, 'copy_link')
        },
      },
      {
        key: 'share',
        sourceType: 'detailModal',
        show: true,
        children: [
          {
            key: 'x',
            onTrack: (element: HTMLElement) => {
              handleClick(data, element, 'share_to_x')
            },
          },
          {
            key: 'facebook',
            onTrack: (element: HTMLElement) => {
              handleClick(data, element, 'share_to_facebook')
            },
          },
        ] as MenuCoreOption[],
      },
      {
        key: 'publish',
        sourceType: 'detailModal',
        show: isMySelf && !isLipSync,
        disabled: isAgentDetail,
        onSuccess: async (data) => {
          if (data) {
            onUpdateVideo?.({ videoData: data })
          }
        },
        onTrack: (element) => {
          handleClick(data, element, 'publish')
        },
      },
      {
        key: 'copyProtection',
        sourceType: 'detailModal',
        show: isMySelf && isPublished,
        onSuccess: async (data) => {
          if (data) {
            onUpdateVideo?.({ videoData: data })
          }
        },
        showTooltip: true,
        onTrack: (element) => {
          handleClick(data, element, 'copy_protection')
        },
      },
      {
        key: 'favorite',
        sourceType: 'detailModal',
        show: isMySelf,
        onSuccess: async (data) => {
          updateFavorite?.(data!.videoId, data!.favorite)
        },
        onTrack: (element) => {
          handleClick(data, element, 'add_to_favorite')
        },
      },
      {
        key: 'download',
        sourceType: 'detailModal',
        show: true,
        children: [
          {
            key: 'with-watermark',
            onTrack: (element: HTMLElement) => {
              handleClick(data, element, 'download_with_watermark')
            },
          },
          {
            key: 'without-watermark',
            onTrack: (element: HTMLElement) => {
              handleClick(data, element, 'download_without_watermark')
            },
          },
        ] as MenuCoreOption[],
      },
      {
        key: 'report',
        sourceType: 'detailModal',
        show: true,
        onTrack: (element) => {
          handleClick(data, element, 'report')
        },
      },
      {
        key: 'delete',
        sourceType: 'detailModal',
        show: isMySelf,
        onTrack: (element) => {
          handleClick(data, element, 'delete')
        },
      },
    ]).filter((item) => item.show)

    return list as MenuCustomOption<TVideoMenuOptionKey>[]
  }, [
    data,
    handleClick,
    isAgentDetail,
    isLipSync,
    isMySelf,
    isPublished,
    onUpdateVideo,
    updateFavorite,
  ])

  const visibleImageOptions = useMemo(() => {
    const list: MenuCustomOption<TImageMenuOptionKey>[] = Array.from<
      MenuCustomOption<TImageMenuOptionKey> & {
        show: boolean
        children?: MenuCoreOption[]
      }
    >([
      {
        key: 'publish',
        sourceType: 'detailModal',
        show: isMySelf && !isLipSync,
        disabled: isAgentDetail,
        onSuccess: async (data) => {
          if (data) {
            onUpdateVideo?.({ videoData: data })
          }
        },
        onTrack: (element) => {
          handleClick(data, element, 'publish')
        },
      },
      {
        key: 'copyLink',
        sourceType: 'detailModal',
        show: true,
        showTooltip: true,
        onTrack: (element) => {
          handleClick(data, element, 'copy_link')
        },
      },
      {
        key: 'copyProtection',
        sourceType: 'detailModal',
        show: isMySelf && isPublished,
        onSuccess: async (data) => {
          if (data) {
            onUpdateVideo?.({ videoData: data })
          }
        },
        showTooltip: true,
        onTrack: (element) => {
          handleClick(data, element, 'copy_protection')
        },
      },
      {
        key: 'share',
        sourceType: 'detailModal',
        show: true,
        children: [
          {
            key: 'x',
            onTrack: (element: HTMLElement) => {
              handleClick(data, element, 'share_to_x')
            },
          },
          {
            key: 'facebook',
            onTrack: (element: HTMLElement) => {
              handleClick(data, element, 'share_to_facebook')
            },
          },
        ] as MenuCoreOption[],
      },
      {
        key: 'favorite',
        sourceType: 'detailModal',
        show: isMySelf,
        onSuccess: async (data) => {
          updateFavorite?.(data!.videoId, data!.favorite)
        },
        onTrack: (element) => {
          handleClick(data, element, 'add_to_favorite')
        },
      },
      {
        key: 'download',
        sourceType: 'detailModal',
        show: true,
        children: [
          {
            key: 'with-watermark',
            onTrack: (element: HTMLElement) => {
              handleClick(data, element, 'download_with_watermark')
            },
          },
          {
            key: 'without-watermark',
            onTrack: (element: HTMLElement) => {
              handleClick(data, element, 'download_without_watermark')
            },
          },
        ] as MenuCoreOption[],
      },
      {
        key: 'report',
        sourceType: 'detailModal',
        show: true,
        onTrack: (element) => {
          handleClick(data, element, 'report')
        },
      },
      {
        key: 'delete',
        sourceType: 'detailModal',
        show: isMySelf,
        onSuccess: async () => {
          onDeleteImageSuccess?.(data.videoId)
        },
        onTrack: (element) => {
          handleClick(data, element, 'delete')
        },
      },
    ]).filter((item) => item.show)

    return list as MenuCustomOption<TImageMenuOptionKey>[]
  }, [
    isMySelf,
    isLipSync,
    isPublished,
    isAgentDetail,
    onUpdateVideo,
    handleClick,
    data,
    updateFavorite,
    onDeleteImageSuccess,
  ])

  const isRecordFromImageTool = getIsRecordFromImageTool(data)

  return (
    <div className={cls`flex w-full items-center gap-2`}>
      <div className='flex shrink-0 items-center gap-2'>
        <VideoLike
          className={cls`bg-f-bg-layout hover:bg-f-bg-hover text-f-text-tertiary hover:text-f-primary group`}
          iconClassName={cls`group-hover:text-f-primary`}
          videoId={data.videoId}
          isLeft={false}
          isLike={data?.isLike || false}
          likeNum={data.starNum}
          onChange={({ isLike, starNum }) => {
            onUpdateVideo?.({
              videoData: {
                ...data,
                isLike,
                starNum,
              },
            })
          }}
          onTrack={(element: HTMLElement) => {
            handleClick(data, element, 'like')
          }}
        />
        {isImage ? (
          <FooterMenuOptions
            data={data}
            visibleOptions={visibleImageOptions}
            menuType={'image'}
            generation={generation}
          />
        ) : (
          <FooterMenuOptions
            data={data}
            visibleOptions={visibleVideoOptions}
            menuType={'video'}
            generation={generation}
          />
        )}
      </div>

      {!isAgentDetail && (
        <>
          {isImage
            ? !isRecordFromImageTool && (
                <CreateSimilarVideo
                  data={data}
                  text={t`Create Similar Image`}
                  openInNewWindow={openInNewWindow}
                />
              )
            : !isRecordGenerateByVideoSound &&
              !isFromVideoTools && (
                <CreateSimilarVideo
                  data={data}
                  showTooltip={isSimilarDisable}
                  tooltipProps={{
                    title: isSimilarDisable
                      ? t`You cannot create a similar video from an extended video.`
                      : '',
                    arrow: false,
                  }}
                  disabled={isSimilarDisable}
                  text={t`Create Similar Video`}
                  openInNewWindow={openInNewWindow}
                />
              )}
        </>
      )}
    </div>
  )
}

export default Footer
