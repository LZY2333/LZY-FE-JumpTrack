import TrackElement from '@/_blocks/Analytics/blocks/TrackElement'
import { useContentTrack } from '@/_blocks/Analytics/hooks/useContentTrack'
import { useScreenIdle } from '@/hooks/screen'
import EllipsisText from '@/pages/pollo.ai/_components/MenuOptions/_components/EllipsisText'
import IconWithTooltip from '@/pages/pollo.ai/_components/MenuOptions/_components/IconWithTooltip'
import { useCreateSimilarVideo } from '@/pages/pollo.ai/_hooks/useCreateSimilarVideo'
import {
  TabType,
  useFormHistoryTabStore,
} from '@/pages/pollo.ai/app/_store/formHistoryTab'
import { useLingui } from '@lingui/react/macro'
import { Button, type ButtonProps } from 'antd'
import { pick } from 'lodash-es'
import React from 'react'

import type { IIconWithTooltipProps } from '@/pages/pollo.ai/_components/MenuOptions/_components/IconWithTooltip'
import type { CreationItem } from '@/pages/pollo.ai/_types/video'

import { useIsProtected } from '../../../../_hooks/useProtected'

interface ICreateSimilarVideoProps
  extends ButtonProps,
    Pick<IIconWithTooltipProps, 'showTooltip' | 'tooltipProps'> {
  data: CreationItem
  text: React.ReactNode
  protectedText?: React.ReactNode
  openInNewWindow?: boolean
}
const CreateSimilarVideo = (props: ICreateSimilarVideoProps) => {
  const {
    data,
    showTooltip,
    tooltipProps,
    text,
    protectedText,
    openInNewWindow = false,
    ...restProps
  } = props

  const { t } = useLingui()

  const { matched } = useScreenIdle('md')
  const { isProtected } = useIsProtected(data)
  const { createSimilarVideo, createSameTool } = useCreateSimilarVideo()
  const { setActiveTab } = useFormHistoryTabStore()

  const { getClickEventParams } = useContentTrack()

  const [isLabelEllipsis, setIsLabelEllipsis] = useState(false)

  const displayText = isProtected ? protectedText || t`Try the Same Tool` : text

  const tooltipTitle = useMemo(() => {
    if (isProtected && matched) return t`Copyright protection enabled`
    if (isLabelEllipsis) return displayText
    return tooltipProps?.title
  }, [
    isProtected,
    tooltipProps?.title,
    t,
    matched,
    isLabelEllipsis,
    displayText,
  ])

  const shouldShowTooltip =
    showTooltip || (isProtected && matched) || isLabelEllipsis

  return (
    <IconWithTooltip
      showTooltip={shouldShowTooltip}
      tooltipProps={{
        ...tooltipProps,
        title: tooltipTitle,
      }}
    >
      <TrackElement clickEvent={getClickEventParams(data, 'create_similar')}>
        <Button
          className={cls`ms-auto flex h-7 min-w-0 items-center gap-x-1 overflow-hidden px-3 text-sm font-semibold md:px-3`}
          type='primary'
          {...restProps}
          onClick={() => {
            setActiveTab(TabType.Create)
            if (isProtected) {
              createSameTool(
                pick(data, ['generateRecord', 'mediaType', 'user', 'videoId']),
                openInNewWindow,
              )
            } else {
              createSimilarVideo(
                {
                  videoId: data?.videoId,
                  generateRecord: data?.generateRecord,
                  mediaType: data?.mediaType,
                  user: data?.user,
                },
                openInNewWindow,
              )
            }
          }}
        >
          <div className={cls`flex w-full min-w-0 items-center`}>
            <EllipsisText className='!mb-0' onEllipsis={setIsLabelEllipsis}>
              {displayText}
            </EllipsisText>
          </div>
        </Button>
      </TrackElement>
    </IconWithTooltip>
  )
}

export default CreateSimilarVideo
