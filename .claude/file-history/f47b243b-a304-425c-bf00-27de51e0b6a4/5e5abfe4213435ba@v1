import CustomSelect from '@/components/antd/CustomSelect'
import { useAntdContext } from '@/contexts/AntdContext/hooks'
import { useDebounceFn, useMemoizedFn } from 'ahooks'
import { Button, Tag } from 'antd'

interface AddCategoryProps {
  value?: string[]
  placeholder?: string
  disabled?: boolean
  className?: string
  templateId: string
  onSuccess?: () => void
  /** 渲染模式：table 模式以 Tag 展示，edit 模式为选择器+提交按钮 */
  mode?: 'table' | 'edit'
}

const EMPTY_VALUE: string[] = []

/** 表格模式下展示 Tag */
const CategoryTags = (props: { value: string[] }) => {
  const { value } = props

  // 获取分类列表用于显示名称
  const { data } = api.category.list.useQuery({
    page: 1,
    pageSize: 100,
  })

  const categoryMap = useMemo(() => {
    const map = new Map<string, string>()
    data?.list?.forEach((item) => {
      map.set(item.categoryId, item.title)
    })
    return map
  }, [data?.list])

  if (value.length === 0) {
    return <span className='text-f-text-tertiary'>-</span>
  }

  return (
    <div className='flex flex-wrap gap-1'>
      {value.map((id) => (
        <Tag key={id} color='blue'>
          {categoryMap.get(id) || id}
        </Tag>
      ))}
    </div>
  )
}

/** 编辑模式下的选择器 */
const CategoryEditor = (props: Omit<AddCategoryProps, 'mode'>) => {
  const {
    value = EMPTY_VALUE,
    placeholder,
    disabled,
    className,
    templateId,
    onSuccess,
  } = props

  const [searchTitle, setSearchTitle] = useState<string | undefined>()
  const [selectedCategories, setSelectedCategories] = useState<string[]>(value)
  const { message } = useAntdContext()

  // 当外部 value 变化时同步更新
  useEffect(() => {
    setSelectedCategories(value)
  }, [value])

  const { data, isFetching } = api.category.list.useQuery({
    page: 1,
    pageSize: 100,
    searchTitle,
  })

  const { mutateAsync: addTemplates, isLoading: isAddingTemplate } =
    api.category.batchAddTemplateToCategory.useMutation()

  const { mutateAsync: removeTemplate, isLoading: isRemovingTemplate } =
    api.category.removeTemplate.useMutation()

  const isSubmitting = isAddingTemplate || isRemovingTemplate

  // 防抖处理搜索
  const { run: handleSearch } = useDebounceFn(
    (searchValue: string) => {
      setSearchTitle(searchValue || undefined)
    },
    { wait: 300 },
  )

  // 选中值变更时重置搜索状态
  const handleChange = useMemoizedFn((selectedValues: string[]) => {
    setSearchTitle(undefined)
    setSelectedCategories(selectedValues)
  })

  // 提交关联变更（包括新增和删除）
  const handleSubmit = useMemoizedFn(async () => {
    // 计算新增的分类
    const addedCategories = selectedCategories.filter(
      (id) => !value.includes(id),
    )
    // 计算删除的分类
    const removedCategories = value.filter(
      (id) => !selectedCategories.includes(id),
    )

    if (addedCategories.length === 0 && removedCategories.length === 0) {
      return
    }

    try {
      await Promise.all([
        // 新增关联
        ...addedCategories.map((categoryId) =>
          addTemplates({
            categoryId,
            templates: [templateId],
          }),
        ),
        // 删除关联
        ...removedCategories.map((categoryId) =>
          removeTemplate({
            categoryId,
            templateId,
          }),
        ),
      ])
      message.success('更新成功')
      onSuccess?.()
    } catch {
      message.error('更新失败，请重试')
    }
  })

  const options = useMemo(() => {
    return (
      data?.list?.map((item) => ({
        label: item.title,
        value: item.categoryId,
      })) ?? []
    )
  }, [data?.list])

  // 计算选择是否有变化
  const hasChanges = useMemo(() => {
    if (selectedCategories.length !== value.length) return true
    const sortedSelected = [...selectedCategories].sort()
    const sortedValue = [...value].sort()
    return sortedSelected.some((id, index) => id !== sortedValue[index])
  }, [selectedCategories, value])

  return (
    <div className='flex items-center gap-2'>
      <CustomSelect
        className={cls`flex-1 ${className}`}
        mode='multiple'
        value={selectedCategories}
        onChange={handleChange}
        placeholder={placeholder}
        disabled={disabled || isSubmitting}
        loading={isFetching}
        showSearch
        filterOption={false}
        onSearch={handleSearch}
        options={options}
        allowClear
      />
      <Button
        type='primary'
        onClick={handleSubmit}
        loading={isSubmitting}
        disabled={!hasChanges}
      >
        提交
      </Button>
    </div>
  )
}

export const AddCategory = (props: AddCategoryProps) => {
  const { mode = 'edit', value = EMPTY_VALUE, ...restProps } = props

  if (mode === 'table') {
    return <CategoryTags value={value} />
  }

  return <CategoryEditor value={value} {...restProps} />
}
