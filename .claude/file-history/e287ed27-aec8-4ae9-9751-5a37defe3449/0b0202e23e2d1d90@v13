import { Trans } from '@lingui/react/macro'
import { useHover } from 'ahooks'
import { Button, type ButtonProps } from 'antd'

import { useButtonState } from '../../_hooks/useButtonState'
import EllipsisText from '../EllipsisText'
import IconWithTooltip from '../IconWithTooltip'
import UpgradeIcon from '../UpgradeIcon'

import type { MenuOption } from '../../_types'

const OptionButton = (
  props: Omit<ButtonProps, 'children' | 'onClick'> & MenuOption,
) => {
  const {
    className,
    premium,
    iconOnly,
    icon: _icon,
    label: _label,
    onClick,
    onTrack,
    tooltipProps,
    showTooltip,
    comingSoon,
    ...restProps
  } = props
  const ref = useRef<HTMLButtonElement>(null)
  const isHovering = useHover(ref)

  const { icon, label, tooltipTitle, setState } = useButtonState({
    icon: _icon,
    label: _label,
    tooltipTitle: tooltipProps?.title,
  })
  const [isLabelEllipsis, setIsLabelEllipsis] = useState(false)
  const { shouldShowButtonTooltip, buttonTooltipProps, displayLabel } =
    useMemo(() => {
      const displayLabel =
        comingSoon && isHovering ? <Trans>Coming Soon</Trans> : label
      // 有自定义tooltipTitle
      const hasCustomTooltip = showTooltip && !!tooltipTitle
      return {
        displayLabel,
        // 有自定义tooltipTitle 或 有缩略label 都展示tooltip
        shouldShowButtonTooltip: hasCustomTooltip || isLabelEllipsis,
        // 优先展示 自定义tooltipTitle；overflow时只传title，避免继承 arrow: false 等配置
        buttonTooltipProps: hasCustomTooltip
          ? { ...tooltipProps, title: tooltipTitle }
          : { title: displayLabel },
      }
    }, [
      comingSoon,
      isHovering,
      label,
      showTooltip,
      tooltipTitle,
      isLabelEllipsis,
      tooltipProps,
    ])

  return (
    <IconWithTooltip
      tooltipProps={buttonTooltipProps}
      showTooltip={shouldShowButtonTooltip}
    >
      <Button
        ref={ref}
        className={tw`!bg-f-bg-layout text-f-text-tertiary flex h-7 items-center gap-x-1 !border-none !px-2 text-sm ${className}`}
        icon={
          comingSoon && isHovering ? null : (
            <CssIcon className={cls`${icon} size-4`} />
          )
        }
        onClick={(e) => {
          onTrack?.(e.currentTarget)
          onClick?.({ ...setState, domEvent: e })
        }}
        {...restProps}
      >
        <div className={cls`flex w-full min-w-0 items-center gap-x-1`}>
          {!iconOnly && (
            <EllipsisText className='!mb-0' onEllipsis={setIsLabelEllipsis}>
              {displayLabel}
            </EllipsisText>
          )}
          {premium && <UpgradeIcon />}
        </div>
      </Button>
    </IconWithTooltip>
  )
}

export default OptionButton
